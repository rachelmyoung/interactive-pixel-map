<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Climate Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      color: #333;
    }

    header {
      padding: 1rem 2rem;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      font-size: 1.5rem;
      font-weight: 600;
    }

    #map-container {
      position: relative;
      height: 90vh;
      background: white;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .floating-tooltip {
      position: absolute;
      background: #ffffff;
      padding: 8px 12px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      pointer-events: none;
      font-size: 0.9rem;
      display: none;
      z-index: 10000;
    }

    .button-group {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1001;
      background: white;
      border-radius: 6px;
      padding: 6px;
    }

    .button-group button {
      background: white;
      border: none;
      margin: 0 5px;
      padding: 6px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    .button-group button:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
<header>Interactive Climate Map</header>
<div id="map-container">
  <div id="map"></div>
  <div id="tooltip" class="floating-tooltip"></div>
  <div class="button-group">
    <button onclick="setMode('pixel')">Pixel View</button>
    <button onclick="setMode('county')">County View</button>
    <button onclick="setMode('state')">State View</button>
  </div>
  <div id="scatter-container" style="display:none;position:absolute;background:white;border:1px solid #ccc;border-radius:6px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:10000;width:160px;height:120px;">
    <canvas id="scatter-canvas" width="150" height="100"></canvas>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
const map = L.map('map', {
  zoomSnap: 0.25,
  center: [39, -98],
  zoom: 4,
  layers: [],
  zoomControl: true
});

fetch('country_borders.geojson')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, {
      style: {
        color: '#333',
        weight: 1,
        fillOpacity: 0
      }
    }).addTo(map);
  });

let currentLayer = null;
let mode = 'pixel';
const tooltip = document.getElementById('tooltip');

function getColor(val) {
  if (val === null || val === undefined || isNaN(val)) return "#ccc";
  const scale = d3.scaleSequential(d3.interpolateYlOrRd).domain([0, 100]);
  return scale(val);
}

function setMode(m) {
  mode = m;
  loadLayer();
}

function showTooltip(content, event) {
  tooltip.style.display = 'block';
  tooltip.innerHTML = content;
  tooltip.style.left = (event.pageX + 15) + 'px';
  tooltip.style.top = (event.pageY + 15) + 'px';
}

function hideTooltip() {
  tooltip.style.display = 'none';
}

function showScatterplot(stateName, values, x, y) {
  const container = document.getElementById('scatter-container');
  container.style.left = (x + 15) + 'px';
  container.style.top = (y + 15) + 'px';
  container.style.display = 'block';

  const canvas = document.getElementById('scatter-canvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = '#BD0026';
  values.forEach(([px, py]) => {
    ctx.beginPath();
    ctx.arc(px * canvas.width, canvas.height - py * canvas.height, 2, 0, 2 * Math.PI);
    ctx.fill();
  });

  const n = values.length;
  if (n > 1) {
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    values.forEach(([x, y]) => {
      sumX += x;
      sumY += y;
      sumXY += x * y;
      sumX2 += x * x;
    });
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;

    ctx.strokeStyle = '#333';
    ctx.beginPath();
    ctx.moveTo(0, canvas.height - intercept * canvas.height);
    ctx.lineTo(canvas.width, canvas.height - (slope + intercept) * canvas.height);
    ctx.stroke();
  }

  ctx.fillStyle = '#333';
  ctx.font = '10px Inter';
  ctx.fillText(stateName, 5, 10);
}

function hideScatterplot() {
  document.getElementById('scatter-container').style.display = 'none';
}

function loadLayer() {
  if (currentLayer) map.removeLayer(currentLayer);

  if (mode === 'pixel') {
    fetch("us_grid_data.json")
      .then(res => res.json())
      .then(data => {
        const layer = L.layerGroup();
        data.forEach(d => {
          const rect = L.rectangle([
            [d.lat, d.lng],
            [d.lat + 0.25, d.lng + 0.25]
          ], {
            fillColor: getColor(d.value),
            color: 'none',
            fillOpacity: 0.7,
            weight: 0
          });

          rect.on("mousemove", e => {
            showTooltip(
              `Pixel value: <strong>${d.value}</strong><br>Lat: ${d.lat}, Lng: ${d.lng}`,
              e.originalEvent
            );
          });

          rect.on("mouseout", hideTooltip);
          layer.addLayer(rect);
        });
        currentLayer = layer;
        layer.addTo(map);
      });
  } else if (mode === 'county') {
    const countyLayer = new L.GeoJSON.AJAX("county_averages.geojson", {
      style: feature => {
        const color = getColor(feature.properties.value);
        return {
          fillColor: color || "#000000",
          weight: 0.5,
          color: "#333",
          fillOpacity: color ? 0.7 : 0.0
        };
      },
      onEachFeature: (feature, layer) => {
        layer.on("mousemove", e => {
          showTooltip(
            `County: <strong>${feature.properties.NAME}</strong><br>` +
            `Avg value: ${feature.properties.value?.toFixed(2) || 'N/A'}`,
            e.originalEvent
          );
        });
        layer.on("mouseout", hideTooltip);
      }
    });
    currentLayer = countyLayer;
    countyLayer.addTo(map);
  } else if (mode === 'state') {
    fetch("us_grid_data.json")
      .then(res => res.json())
      .then(pixels => {
        fetch("state_averages.geojson")
          .then(res => res.json())
          .then(statesGeo => {
            const stateLayer = L.geoJSON(statesGeo, {
              style: feature => {
                const color = getColor(feature.properties.value);
                return {
                  fillColor: color || "#ccc",
                  color: "#333",
                  weight: 1,
                  fillOpacity: color ? 0.5 : 0.0
                };
              },
              onEachFeature: (feature, layer) => {
                layer.on("mousemove", e => {
                  const bounds = layer.getBounds();
                  const statePixels = pixels.filter(p =>
                    p.lng >= bounds.getWest() && p.lng <= bounds.getEast() &&
                    p.lat >= bounds.getSouth() && p.lat <= bounds.getNorth() &&
                    p.value != null && !isNaN(p.value)
                  );
                  const minVal = d3.min(statePixels, d => d.value);
                  const maxVal = d3.max(statePixels, d => d.value);
                  const values = statePixels.map(p => [
                    Math.random(),
                    (p.value - minVal) / (maxVal - minVal)
                  ]);

                  showScatterplot(
                    `${feature.properties.NAME} (${feature.properties.value?.toFixed(2) || 'N/A'})`,
                    values,
                    e.originalEvent.pageX,
                    e.originalEvent.pageY
                  );
                });
                layer.on("mouseout", hideScatterplot);
              }
            });
            currentLayer = stateLayer;
            stateLayer.addTo(map);
          });
      });
  }
}

loadLayer();
</script>
</body>
</html>
