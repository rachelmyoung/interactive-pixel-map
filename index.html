<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Climate Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      color: #333;
    }

    header {
      padding: 1rem 2rem;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      font-size: 1.5rem;
      font-weight: 600;
    }

    #map {
      background-color: white;
    }

    #map-container {
      position: relative;
      height: calc(100vh - 70px);
      background: white;
    }

    #map {
      height: 100%;
      width: 100%;
      border: 1px solid #ccc;
    }

    .floating-tooltip {
      position: absolute;
      background: #ffffff;
      padding: 8px 12px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      pointer-events: none;
      font-size: 0.9rem;
      display: none;
      z-index: 10000; /* <-- bump this up */
    }

    .button-group {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1001;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px;
    }

    .button-group button {
      background: white;
      border: none;
      margin: 0 5px;
      padding: 6px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    .button-group button:hover {
      background: #f0f0f0;
    }

    
  </style>
</head>
<body>
<div class="floating-tooltip" id="tooltip"></div>
<div id="map-container">
  <div id="map"></div>
  <div class="button-group">
    <button onclick="setMode('pixel')">Pixel View</button>
    <button onclick="setMode('county')">County View</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>

<script>
const map = L.map('map', {
  zoomSnap: 0.25,
  center: [39, -98],
  zoom: 4,
  layers: [],       // start with no base tile layer
  zoomControl: true
});

// Optional: Add country boundary lines GeoJSON with no fill
fetch('country_borders.geojson')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, {
      style: {
        color: '#333',    // dark gray lines
        weight: 1,
        fillOpacity: 0    // no fill
      }
    }).addTo(map);
  });

let currentLayer = null;
let mode = 'pixel';

const tooltip = document.getElementById('tooltip');

function getColor(val) {
  if (val === null || val === undefined || isNaN(val) || val === 0) return null;  // Treat 0 as NA
  return val > 80 ? '#800026' :
         val > 60 ? '#BD0026' :
         val > 40 ? '#E31A1C' :
         val > 20 ? '#FC4E2A' :
                    '#FFEDA0';
}


function setMode(m) {
  mode = m;
  loadLayer();
}

function showTooltip(content, event) {
  tooltip.style.display = 'block';
  tooltip.innerHTML = content;
  tooltip.style.left = (event.pageX + 15) + 'px';
  tooltip.style.top = (event.pageY + 15) + 'px';
}


function hideTooltip() {
  tooltip.style.display = 'none';
}

function loadLayer() {
  if (currentLayer) map.removeLayer(currentLayer);

  if (mode === 'pixel') {
    fetch("us_grid_data.json")
      .then(res => res.json())
      .then(data => {
        const layer = L.layerGroup();
        data.forEach(d => {
          const rect =L.rectangle([
                [d.lat, d.lng],
                [d.lat + 0.25, d.lng + 0.25]
              ], {
                fillColor: getColor(d.value),
                color: 'none',            // no border stroke color
                fillOpacity: 0.7,
                weight: 0
              });

          rect.on("mousemove", e => {
            showTooltip(
              `Pixel value: <strong>${d.value}</strong><br>Lat: ${d.lat}, Lng: ${d.lng}`, 
              e.originalEvent
            );
          });

          rect.on("mouseout", hideTooltip);
          layer.addLayer(rect);
        });
        currentLayer = layer;
        layer.addTo(map);
      });
  } else if (mode === 'county') {
    const countyLayer = new L.GeoJSON.AJAX("county_averages.geojson", {
      style: feature => {
          const color = getColor(feature.properties.value);
          return {
            fillColor: color || "#000000",  // fallback (won't matter since opacity is 0)
            weight: 0.5,
            color: "#333",
            fillOpacity: color ? 0.7 : 0.0  // fully transparent if NA
          };
        },
      onEachFeature: (feature, layer) => {
        layer.on("mousemove", e => {
          showTooltip(
            `County: <strong>${feature.properties.NAME}</strong><br>` +
            `Avg value: ${feature.properties.value?.toFixed(2) || 'N/A'}`, 
            e.originalEvent
          );
        });
        layer.on("mouseout", hideTooltip);
      }
    });
    currentLayer = countyLayer;
    countyLayer.addTo(map);
  }
}

// Load initial view
loadLayer();

</script>
</body>
</html>

